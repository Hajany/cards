#
#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing,
#  software distributed under the License is distributed on an
#  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#  KIND, either express or implied.  See the License for the
#  specific language governing permissions and limitations
#  under the License.
#

# This is the LDAP connection information (bind DN, bind password, host name, etc.).
# The generic external authentication support is defined in 25-external-auth.txt
[feature name=ldap-connection]

[variables]
    oak.version=1.8.8

# Add the modules needed for LDAP authentication
[artifacts startLevel=15]
    # This adds support for LDAP as a specific external authenticator
    org.apache.jackrabbit/oak-auth-ldap/${oak.version}


# The configuration in this file uses properties defined in the pom.xml file (Maven properties).
# However, in the pom.xml these properties are defined as empty, which means that by default no connection is configured, so LDAP isn't enabled.
# The preferred way to configure these during the build is to define them in the `~/.m2/settings.xml` file, which is local to the developer's machine.
# Here's an example configuration:
#
# <settings>
#   <profiles>
#     <profile>
#       <id>sickkids-ldap</id>
#       <properties>
#         <lfs.ldap.dn>CN\=Service\ User,OU\=Service\ Accounts,DC\=sickkids,DC\=ca</lfs.ldap.dn>
#         <lfs.ldap.password>the password</lfs.ldap.password>
#         <lfs.ldap.host>sickkids.ca</lfs.ldap.host>
#         <lfs.ldap.baseDn>DC\=sickkids,DC\=ca</lfs.ldap.baseDn>
#         <lfs.ldap.idAttribute>sAMAccountName</lfs.ldap.idAttribute>
#         <lfs.ldap.userClass>user</lfs.ldap.userClass>
#       </properties>
#     </profile>
#   </profiles>
#   <activeProfiles>
#     <activeProfile>sickkids-ldap</activeProfile>
#   </activeProfiles>
# </settings>
#
# After the build, the actual values will be substituted and included in the final artifact.
# This means that:
#
# 1. The username AND PASSWORD (!!!) will be stored as plain text in the artifact.
# 2. If the developer does have the LDAP credentials configured, during a release these developer-specific settings will be embedded in the released artifact, which is probably not what is needed.
#
# So, if the LDAP integration isn't actively tested during each build, it is recommended to NOT make the profile active by default in the settings, but to explicitly enable it for specific builds by using the `-P profile-name` parameter when invoking mvn, for example:
#
# mvn clean install -Psickkids-ldap
#
# For configuring the LDAP connection in a running instance, there are two options: creating the config on the filesystem, or through the UI.
#
# 1. Filesystem option: create a file in the $SLINGHOME/config/org/apache/jackrabbit/oak/security/authentication/ldap/impl/LdapIdentityProvider.config with the following content:
#
# :org.apache.felix.configadmin.revision:=L"1"
# bind.dn="CN\=Service\ User,OU\=Service\ Accounts,DC\=sickkids,DC\=ca"
# bind.password="the password"
# host.name="sickkids.ca"
# provider.name="ldap"
# service.pid="org.apache.jackrabbit.oak.security.authentication.ldap.impl.LdapIdentityProvider"
# user.baseDN="DC\=sickkids,DC\=ca"
# user.idAttribute="sAMAccountName"
# user.objectclass=[ "user"]
#
# Don't forget to restart the application afterwards.
#
# 2. UI option: start the application, log-in with the admin account, open http://localhost:8080/system/console/configMgr in a browser (use the correct protocol, hostname and port), edit the configuration for "Apache Jackrabbit Oak LDAP Identity Provider", and enter the right values for "LDAP Server Hostname", "Bind DN", "Bind Password" and any other fields that need to be configured.

[configurations]
  org.apache.jackrabbit.oak.security.authentication.ldap.impl.LdapIdentityProvider-default
    bind.dn="${lfs.ldap.dn}"
    bind.password="${lfs.ldap.password}"
    host.name="${lfs.ldap.host}"
    provider.name="ldap"
    user.baseDN="${lfs.ldap.baseDn}"
    user.idAttribute="${lfs.ldap.idAttribute}"
    user.objectclass=["${lfs.ldap.userClass}"]
